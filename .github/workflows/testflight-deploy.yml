name: Testflight Deploy
on:
  push:
    branches:
      - setting/#109
      - develop
    tags:
      - 'v*' # 태그: v1.0.0 형식
jobs:
  deploy:
    name: Deploy Testflight
    runs-on: macos-14
    
    env:
      CI: true
      SCHEME_NAME: ${{ secrets.SCHEME_NAME }}
      WORKSPACE_NAME: ${{ secrets.XCWORKSPACE_NAME }}
      APP_IDENTIFIER: ${{ secrets.APP_IDENTIFIER }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      TEAM_ID: ${{ secrets.TEAM_ID }}
      ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
      ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
      ASC_KEY_CONTENT: ${{ secrets.ASC_KEY_CONTENT }}
      MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
      MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      MATCH_KEYCHAIN_PASSWORD: ${{ secrets.MATCH_KEYCHAIN_PASSWORD }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      BUILD_NUMBER: ${{ github.run_number }}
      FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 120
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set Xcode version
        uses: maxim-lobanov/setup-xcode@v1.5.1
        with:
          xcode-version: '16.2'
      
      - name: Get repository path information
        id: repo-info
        run: |
          echo "REPO_DIR=$(pwd)" >> $GITHUB_ENV
          echo "REPO_NAME=$(basename $(pwd))" >> $GITHUB_ENV
          echo "Repository details:"
          echo "Directory: $(pwd)"
          echo "Name: $(basename $(pwd))"
      
      - name: Create xcconfig files for CI
        run: |
          # Extract parts from the error path pattern
          # /Users/runner/work/REPO_NAME/REPO_NAME/SCHEME_NAME/Global/Settings/Config/Release.xcconfig
          
          CONFIG_DIR="/Users/runner/work/$REPO_NAME/$REPO_NAME/$SCHEME_NAME/Global/Settings/Config"
          echo "Creating config directory: $CONFIG_DIR"
          mkdir -p "$CONFIG_DIR"
          
          # Create Shared.xcconfig
          echo "GOOGLE_CLIENT_ID = ${{ secrets.GOOGLE_CLIENT_ID }}" > "$CONFIG_DIR/Shared.xcconfig"
          echo "GOOGLE_WEB_CLIENT_ID = ${{ secrets.GOOGLE_WEB_CLIENT_ID }}" >> "$CONFIG_DIR/Shared.xcconfig"
          echo "NMAP_CLIENT_KEY = ${{ secrets.NMAP_CLIENT_KEY }}" >> "$CONFIG_DIR/Shared.xcconfig"
          
          # Create Release.xcconfig
          echo "#include \"Shared.xcconfig\"" > "$CONFIG_DIR/Release.xcconfig"
          echo "BASE_URL = ${{ secrets.BASE_URL }}" >> "$CONFIG_DIR/Release.xcconfig"
          echo "AMPLITUDE_KEY = ${{ secrets.AMPLITUDE_KEY }}" >> "$CONFIG_DIR/Release.xcconfig"
          
          # Create Debug.xcconfig
          echo "#include \"Shared.xcconfig\"" > "$CONFIG_DIR/Debug.xcconfig"
          echo "BASE_URL = ${{ secrets.BASE_URL }}" >> "$CONFIG_DIR/Debug.xcconfig"
          echo "AMPLITUDE_KEY = ${{ secrets.AMPLITUDE_KEY }}" >> "$CONFIG_DIR/Debug.xcconfig"
          
          # Verify files
          echo "Files created in $CONFIG_DIR:"
          ls -la "$CONFIG_DIR"
      
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          
      - name: Install dependencies
        working-directory: ./ACON-iOS
        run: bundle install
      
      - name: Set up Git credentials for match
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.MATCH_SSH_PRIVATE_KEY }}
      
      - name: Deploy to TestFlight
        working-directory: ./ACON-iOS
        run: bundle exec fastlane beta
        env:
          ENVIRONMENT: ${{ startsWith(github.ref, 'refs/tags/v') && contains(github.ref, '-prod') && 'production' || 'development' }}
